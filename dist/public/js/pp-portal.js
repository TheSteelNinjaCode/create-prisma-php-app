class m{portals=new Map;portalCounter=0;componentManager;domBindingManager;cleanupObserver;stateManager;pphpInstance;constructor(){this.cleanupObserver=new MutationObserver(e=>{this.handleMutations(e)}),this.cleanupObserver.observe(document.body,{childList:!0,subtree:!0})}setDependencies(e,t,n,r){this.componentManager=e,this.domBindingManager=t,this.stateManager=n,this.pphpInstance=r}createPortal(e,t,n){const r=typeof t=="string"?document.querySelector(t):t;if(!r)throw new Error(`Portal container not found: ${t}`);const o=this.componentManager?.getCurrentComponent()||"app",a=n?.key||`portal_${++this.portalCounter}_${Date.now()}`;this.portals.has(a)&&this.removePortal(a);const s={id:a,content:e,container:r,component:o};return this.portals.set(a,s),this.renderPortalWithHydration(s,n,a),a}async renderPortalWithHydration(e,t,n){if(!this.componentManager||!this.domBindingManager){console.warn("PortalManager dependencies not set");return}try{await this.renderPortal(e,t),await new Promise(r=>requestAnimationFrame(r)),this.domBindingManager.processPendingBindings(),await new Promise(r=>{this.stateManager?.onDOMUpdateComplete(()=>{r(void 0)})}),this.pphpInstance&&this.pphpInstance.markPortalHydrated&&this.pphpInstance.markPortalHydrated(n),t?.onMount&&t.onMount(e.container)}catch(r){console.error("Portal hydration error:",r),this.pphpInstance&&this.pphpInstance.markPortalHydrated&&this.pphpInstance.markPortalHydrated(n)}}renderPortal(e,t){return new Promise((n,r)=>{if(!this.componentManager||!this.domBindingManager){console.warn("PortalManager dependencies not set"),r(new Error("Dependencies not set"));return}try{e.renderedContent&&e.renderedContent.parentElement&&e.renderedContent.parentElement.removeChild(e.renderedContent);let o;if(typeof e.content=="string"){const s=document.createElement("template");if(s.innerHTML=e.content.trim(),o=s.content.firstElementChild,!o)throw new Error("Invalid HTML string for portal content")}else if(e.content instanceof DocumentFragment){const s=document.createElement("div");if(s.appendChild(e.content.cloneNode(!0)),o=s.firstElementChild,!o)throw new Error("DocumentFragment must contain at least one element")}else o=e.content;o.setAttribute("data-portal-id",e.id),o.setAttribute("data-portal-component",e.component),e.container.appendChild(o),e.renderedContent=o;const a=[...this.componentManager.componentStack];try{this.componentManager.executePhpScripts(o),this.domBindingManager.processElement(o,!0);const s=o.querySelectorAll("template[pp-for]"),i=this.domBindingManager.loopManager;i&&(s.forEach(d=>{const l=d;if(i.loopBindings?.has(l))if(typeof i.updateTemplateParent=="function")i.updateTemplateParent(l);else{const c=i.loopBindings.get(l);c&&(c.subscriptionIds?.forEach(p=>{this.stateManager?.removeSubscription(p)}),i.loopBindings.delete(l)),i.processTemplate(l,e.component)}else i.queueTemplate(l,e.component)}),i.processPendingTemplates()),this.domBindingManager.processPendingBindings(),n()}finally{this.componentManager.componentStack=a}}catch(o){console.error("Portal rendering error:",o),this.portals.delete(e.id),r(o)}})}removePortal(e){const t=this.portals.get(e);if(!t)return!1;try{return t.cleanup&&t.cleanup(),t.renderedContent&&this.cleanupPortalElement(t.renderedContent),t.renderedContent&&t.renderedContent.parentElement&&t.renderedContent.parentElement.removeChild(t.renderedContent),this.portals.delete(e),!0}catch(n){return console.error("Portal cleanup error:",n),!1}}cleanupPortalElement(e){if(this.stateManager){const t=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,null);let n=e;do n.nodeType===Node.ELEMENT_NODE&&this.stateManager.subscriptionManager?.cleanupElement(n);while(n=t.nextNode())}}updatePortal(e,t,n){const r=this.portals.get(e);return r?(r.content=t,this.renderPortal(r,n),!0):!1}getPortal(e){return this.portals.get(e)}hasPortal(e){return this.portals.has(e)}getAllPortals(){return Array.from(this.portals.values())}handleMutations(e){for(const t of e)t.type==="childList"&&t.removedNodes.forEach(n=>{if(n.nodeType===Node.ELEMENT_NODE){const r=n;for(const[o,a]of this.portals)(a.container===r||r.contains(a.container))&&this.removePortal(o)}})}destroy(){for(const e of Array.from(this.portals.keys()))this.removePortal(e);this.cleanupObserver.disconnect(),this.portals.clear()}}export{m as P};
