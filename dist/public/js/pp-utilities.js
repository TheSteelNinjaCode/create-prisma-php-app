import{PPHP as y}from"./reactive-v1.js";class w extends y{cryptoKey=null;activeAbortController=null;constructor(){super(),this.hydrated().then((()=>{document.body.hidden=!1}))}async redirect(t){if(t)try{new URL(t,window.location.origin).origin!==window.location.origin?window.location.href=t:history.pushState(null,"",t)}catch(t){console.error("Redirect error:",t)}}async initCryptoKey(){const t=document.cookie.split("; ").find((t=>t.startsWith("pp_function_call_jwt=")))?.split("=",2)[1];if(!t)throw new Error("Missing function-call token");const[,e]=t.split("."),r=atob(e.replace(/-/g,"+").replace(/_/g,"/")),{k:o,exp:n}=JSON.parse(r);if(Date.now()/1e3>n)throw new Error("Function-call token expired");const i=Uint8Array.from(atob(o),(t=>t.charCodeAt(0)));this.cryptoKey=await crypto.subtle.importKey("raw",i,{name:"AES-CBC"},!1,["encrypt","decrypt"])}async encryptCallbackName(t){await this.initCryptoKey();const e=crypto.getRandomValues(new Uint8Array(16)),r=(new TextEncoder).encode(t),o=await crypto.subtle.encrypt({name:"AES-CBC",iv:e},this.cryptoKey,r);return`${btoa(String.fromCharCode(...e))}:${btoa(String.fromCharCode(...new Uint8Array(o)))}`}createFetchOptions(t){return{method:"POST",headers:{"Content-Type":"application/json",HTTP_PP_WIRE_REQUEST:"true"},body:JSON.stringify(t)}}async fetchFunction(t,e={},r=!1){let o=null;try{r&&this.activeAbortController&&(this.activeAbortController.abort(),this.activeAbortController=null),o=new AbortController,r&&(this.activeAbortController=o);const n={callback:await this.encryptCallbackName(t),...e},i=window.location.href;let a;if(Object.keys(n).some((t=>{const e=n[t];return e instanceof File||e instanceof FileList&&e.length>0}))){const t=new FormData;Object.keys(n).forEach((e=>{const r=n[e];r instanceof File?t.append(e,r):r instanceof FileList?Array.from(r).forEach((r=>t.append(e,r))):t.append(e,r)})),a={method:"POST",headers:{HTTP_PP_WIRE_REQUEST:"true"},body:t,signal:o.signal}}else a={signal:o.signal,...this.createFetchOptions(n)};const c=await fetch(i,a);if(!c.ok)throw new Error(`Fetch failed with status: ${c.status} ${c.statusText}`);const l=await c.text();o&&this.activeAbortController===o&&(this.activeAbortController=null);try{return JSON.parse(l)}catch{return l}}catch(t){if(o&&this.activeAbortController===o&&(this.activeAbortController=null),t instanceof Error&&"AbortError"===t.name)return console.log("Request was cancelled"),{cancelled:!0};throw console.error("Error in fetchFunction:",t),new Error("Failed to fetch data.")}}}window.pp=new w;export{w as PPHPUtilities};